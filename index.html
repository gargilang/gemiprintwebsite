<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Input Keuangan</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #form-container { display: none; margin-top: 20px; }
    label { display: block; margin-top: 10px; }
    input, select { width: 200px; padding: 5px; }
    button { margin-top: 15px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h2>Input Data Keuangan</h2>
  <button id="btnTambah">Tambah</button>

  <div id="form-container">
    <form id="keuanganForm">
      <label>Tanggal:
        <input type="date" id="tanggal" required>
      </label>
      <label>Debit (Rp):
        <input type="number" id="debit" min="0">
      </label>
      <label>Kredit (Rp):
        <input type="number" id="kredit" min="0">
      </label>
      <label>Kategori:
        <select id="kategori" required>
          <option value="">-- Pilih --</option>
          <option>KAS</option>
          <option>BIAYA</option>
          <option>OMZET</option>
          <option>INVESTOR</option>
          <option>SUBSIDI</option>
          <option>LUNAS</option>
          <option>SUPPLY</option>
          <option>LABA</option>
          <option>KOMISI</option>
          <option>TABUNGAN</option>
          <option>HUTANG</option>
          <option>PIUTANG</option>
          <option>PRIBADI-A</option>
          <option>PRIBADI-S</option>
        </select>
      </label>
      <label>Keperluan:
        <input type="text" id="keperluan">
      </label>
      <button type="submit">Simpan</button>
    </form>
  </div>

  <script>
    // Konfigurasi Supabase
    const SUPABASE_URL = "https://ubhsxvhjkshggzmfgsyw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViaHN4dmhqa3NoZ2d6bWZnc3l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0OTkzMzAsImV4cCI6MjA3NjA3NTMzMH0.VkYKzRt2_GEGFron3unm5E7oQK96H0d3aM7pijdGW5U";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Tombol tambah
    document.getElementById("btnTambah").addEventListener("click", () => {
      document.getElementById("form-container").style.display = "block";
    });

    // Submit form
    document.getElementById("keuanganForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const tanggal = document.getElementById("tanggal").value;
      const debit = parseFloat(document.getElementById("debit").value) || 0;
      const kredit = parseFloat(document.getElementById("kredit").value) || 0;
      const kategori = document.getElementById("kategori").value;
      const keperluan = document.getElementById("keperluan").value;

      // Validasi: debit dan kredit tidak boleh keduanya terisi
      if (debit > 0 && kredit > 0) {
        alert("Hanya boleh mengisi Debit ATAU Kredit, bukan keduanya.");
        return;
      }

      // Ambil total omzet terakhir
      let { data: existing, error: fetchError } = await supabase
        .from("keuangan")
        .select("omzet, laba_bersih, bagi_hasil_anwar, bagi_hasil_suri, bagi_hasil_gemi")
        .order("id", { ascending: false })
        .limit(1);

      let omzet = 0, laba_bersih = 0, bagi_hasil_anwar = 0, bagi_hasil_suri = 0, bagi_hasil_gemi = 0;

      if (existing && existing.length > 0) {
        omzet = parseFloat(existing[0].omzet) || 0;
        laba_bersih = parseFloat(existing[0].laba_bersih) || 0;
        bagi_hasil_anwar = parseFloat(existing[0].bagi_hasil_anwar) || 0;
        bagi_hasil_suri = parseFloat(existing[0].bagi_hasil_suri) || 0;
        bagi_hasil_gemi = parseFloat(existing[0].bagi_hasil_gemi) || 0;
      }

      // Logika khusus kategori OMZET
      if (kategori === "OMZET" && debit > 0) {
        omzet += debit;
        laba_bersih = omzet / 3;
        bagi_hasil_anwar = laba_bersih;
        bagi_hasil_suri = laba_bersih;
        bagi_hasil_gemi = laba_bersih;
      }

      // Insert ke tabel
      const { data, error } = await supabase
        .from("keuangan")
        .insert([{
          tanggal,
          debit,
          kredit,
          kategori,
          keperluan,
          omzet,
          laba_bersih,
          bagi_hasil_anwar,
          bagi_hasil_suri,
          bagi_hasil_gemi
        }]);

      if (error) {
        console.error(error);
        alert("Gagal menyimpan data: " + error.message);
      } else {
        alert("Data berhasil disimpan!");
        document.getElementById("keuanganForm").reset();
      }
    });
  </script>
</body>
</html>
